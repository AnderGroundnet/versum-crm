<!DOCTYPE html>
<html lang="es">
  <link rel="icon" href="https://ugc.production.linktr.ee/150b3aee-d095-4ab2-9f24-535c1adacbef_Captura-de-pantalla-2025-07-28-a-las-12.05.32.png" type="image/jpeg">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VERSUM CRM</title>
  <link rel="icon" href="https://ugc.production.linktr.ee/150b3aee-d095-4ab2-9f24-535c1adacbef_Captura-de-pantalla-2025-07-28-a-las-12.05.32.png" type="image/png">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f3f4f6; }
    .container { max-width: 1200px; margin: 0 auto; padding: 1rem; }
    .card { background: white; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 1.5rem; margin-bottom: 1rem; }
    .btn { padding: 0.75rem 1.5rem; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: 0.2s; }
    .btn-gold { background: linear-gradient(135deg, #D4A574, #C8A882); color: white; }
    .btn-gold:hover { opacity: 0.9; }
    .btn-blue { background: #3b82f6; color: white; }
    .btn-red { background: #ef4444; color: white; }
    .btn-gray { background: #6b7280; color: white; }
    .btn-sm { padding: 0.5rem 1rem; font-size: 0.875rem; }
    .input, .select, .textarea { width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 8px; font-size: 1rem; }
    .input:focus, .select:focus, .textarea:focus { outline: none; border-color: #D4A574; }
    .label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151; font-size: 0.875rem; }
    .gold { color: #D4A574; }
    .header { background: #000; color: white; padding: 1rem; }
    .nav { background: white; border-bottom: 1px solid #e5e7eb; padding: 0 1rem; display: flex; gap: 0.5rem; }
    .nav-btn { padding: 1rem; background: none; border: none; border-bottom: 2px solid transparent; cursor: pointer; }
    .nav-btn.active { border-bottom-color: #D4A574; color: #D4A574; }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
    .modal.active { display: flex; }
    .modal-content { background: white; border-radius: 12px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; margin: 1rem; }
    .modal-header { padding: 1.5rem; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; }
    .modal-body { padding: 1.5rem; }
    .modal-footer { padding: 1.5rem; border-top: 1px solid #e5e7eb; display: flex; gap: 0.5rem; justify-content: flex-end; }
    .badge { display: inline-block; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }
    .badge-blue { background: #dbeafe; color: #1e40af; }
    .badge-green { background: #d1fae5; color: #065f46; }
    .badge-orange { background: #fed7aa; color: #9a3412; }
    .text-center { text-align: center; }
    .text-lg { font-size: 1.125rem; }
    .text-xl { font-size: 1.25rem; }
    .text-2xl { font-size: 1.5rem; }
    .font-bold { font-weight: 700; }
    .text-gray-600 { color: #4b5563; }
    .flex { display: flex; }
    .justify-between { justify-content: space-between; }
    .gap-2 { gap: 0.5rem; }
    .mb-4 { margin-bottom: 1rem; }
    .mt-2 { margin-top: 0.5rem; }
    .py-8 { padding: 2rem 0; }
    .grid { display: grid; gap: 1rem; }
    .grid-2 { grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); }
    .notification { position: fixed; top: 1rem; right: 1rem; background: white; padding: 1rem 1.5rem; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: none; z-index: 2000; border-left: 4px solid #D4A574; }
    .notification.show { display: block; }
  </style>
</head>
<body>
  <div id="root">Cargando...</div>
  <div id="notification" class="notification"></div>
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
// ============================================
// M√ìDULO 2: CONFIGURACI√ìN + LOGIN
// ============================================

// CONFIGURACI√ìN - Reemplaza con tus credenciales
const SUPABASE_URL = 'https://pqwlzrfqmhmsvbqjscgj.supabase.co';
const SUPABASE_KEY =  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBxd2x6cmZxbWhtc3ZicWpzY2dqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2NDMyMDAsImV4cCI6MjA4NDIxOTIwMH0.aQo1-ZGyTpmNMHZS7FnppxDExv9nMrp7oxfFkfj5Bhw';

if (SUPABASE_URL === 'TU_URL_AQUI' || SUPABASE_KEY === 'TU_API_KEY_AQUI') {
  document.getElementById('root').innerHTML = `
    <div style="min-height: 100vh; background: #000; display: flex; align-items: center; justify-content: center; padding: 1rem;">
      <div style="background: white; border-radius: 16px; padding: 2rem; max-width: 400px;">
        <h1 style="font-size: 1.5rem; font-weight: 700; text-align: center; margin-bottom: 1rem;">‚ö†Ô∏è Configuraci√≥n Pendiente</h1>
        <p style="color: #6b7280; margin-bottom: 1rem;">Reemplaza SUPABASE_URL y SUPABASE_KEY en el c√≥digo.</p>
      </div>
    </div>
  `;
  throw new Error('Configuraci√≥n pendiente');
}

const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// Utilidad para notificaciones
function showNotification(message, duration = 3000) {
  const notif = document.getElementById('notification');
  notif.textContent = message;
  notif.classList.add('show');
  setTimeout(() => notif.classList.remove('show'), duration);
}

// ============================================
// CLASE PRINCIPAL
// ============================================
class VersumCRM {
  constructor() {
    this.currentUser = null;
    this.currentTab = 'clientes';
    this.editingCliente = null;
    this.comerciales = [];
    this.init();
  }

  async init() {
    const savedUser = localStorage.getItem('versum_user');
    if (savedUser) {
      this.currentUser = JSON.parse(savedUser);
      await this.loadComerciales();
      this.renderDashboard();
    } else {
      this.renderLogin();
    }
  }

  async loadComerciales() {
    try {
      const { data } = await supabaseClient
        .from('usuarios')
        .select('id, nombre, email, rol')
        .eq('activo', true);
      this.comerciales = data || [];
    } catch (err) {
      console.error('Error cargando comerciales:', err);
    }
  }

  // ============================================
  // LOGIN
  // ============================================
  renderLogin() {
    document.getElementById('root').innerHTML = `
      <div style="min-height: 100vh; background: #000; display: flex; align-items: center; justify-content: center; padding: 1rem;">
        <div style="background: white; border-radius: 16px; padding: 2rem; max-width: 400px; width: 100%;">
          <div style="width: 80px; height: 80px; background: #000; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem; font-size: 2rem;">üç∫</div>
          <h1 style="font-size: 1.5rem; font-weight: 700; text-align: center; margin-bottom: 0.5rem;">VERSUM</h1>
          <p style="color: #D4A574; text-align: center; font-weight: 600; margin-bottom: 2rem;">Sistema de Gesti√≥n CRM</p>
          
          <form onsubmit="app.handleLogin(event)">
            <div style="margin-bottom: 1rem;">
              <label class="label">Email</label>
              <input type="email" id="email" class="input" required placeholder="tu@email.com" />
            </div>
            
            <div style="margin-bottom: 1rem;">
              <label class="label">Contrase√±a</label>
              <input type="password" id="password" class="input" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
            </div>
            
            <button type="submit" class="btn btn-gold" style="width: 100%;">Iniciar Sesi√≥n</button>
          </form>

          <div style="background: #dbeafe; border: 1px solid #93c5fd; border-radius: 8px; padding: 1rem; margin-top: 1rem;">
            <p style="font-size: 0.875rem; font-weight: 600;">Credenciales iniciales:</p>
            <p style="font-size: 0.875rem; margin-top: 0.5rem;">Email: <strong>ceo@versum.com</strong></p>
            <p style="font-size: 0.875rem;">Contrase√±a: <strong>versum2024</strong></p>
          </div>
        </div>
      </div>
    `;
  }

  async handleLogin(e) {
    e.preventDefault();
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;

    try {
      const { data, error } = await supabaseClient
        .from('usuarios')
        .select('*')
        .eq('email', email)
        .eq('activo', true)
        .single();

      if (error || !data) {
        showNotification('‚ùå Usuario o contrase√±a incorrectos');
        return;
      }

      if (password === 'versum2024' || password === data.password_hash) {
        this.currentUser = data;
        localStorage.setItem('versum_user', JSON.stringify(data));
        await this.loadComerciales();
        this.renderDashboard();
        showNotification('‚úÖ Bienvenido a VERSUM');
      } else {
        showNotification('‚ùå Usuario o contrase√±a incorrectos');
      }
    } catch (err) {
      console.error('Error login:', err);
      showNotification('‚ùå Error al iniciar sesi√≥n');
    }
  }

  logout() {
    this.currentUser = null;
    localStorage.removeItem('versum_user');
    this.renderLogin();
  }

  // ============================================
  // DASHBOARD (contin√∫a en M√≥dulo 3)
  // ============================================
// ============================================
  // M√ìDULO 3: DASHBOARD + NAVEGACI√ìN
  // ============================================
  
  renderDashboard() {
    const roleName = {
      ceo: 'CEO',
      admin: 'Administrador',
      comercial: 'Comercial'
    }[this.currentUser.rol] || this.currentUser.rol;

    document.getElementById('root').innerHTML = `
      <div>
        <!-- Header -->
        <div class="header">
          <div class="container flex justify-between">
            <div class="flex gap-2">
              <div style="width: 50px; height: 50px; background: #D4A574; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">üç∫</div>
              <div>
                <h1 class="text-xl font-bold">VERSUM CRM</h1>
                <p style="font-size: 0.875rem; color: #D4A574;">${this.currentUser.nombre} - ${roleName}</p>
              </div>
            </div>
            <button onclick="app.logout()" class="btn btn-gray btn-sm">Salir</button>
          </div>
        </div>

        <!-- Navegaci√≥n -->
        <div class="nav">
          <div class="container" style="padding: 0;">
            <button onclick="app.navigateTo('clientes')" class="nav-btn active" id="nav-clientes">üë• Clientes</button>
            <button onclick="app.navigateTo('productos')" class="nav-btn" id="nav-productos">üì¶ Productos</button>
            <button onclick="app.navigateTo('agenda')" class="nav-btn" id="nav-agenda">üìÖ Agenda</button>
            <button onclick="app.navigateTo('finanzas')" class="nav-btn" id="nav-finanzas">üí∞ Finanzas</button>
            ${(this.currentUser.rol === 'ceo' || this.currentUser.rol === 'admin') 
              ? '<button onclick="app.navigateTo(\'usuarios\')" class="nav-btn" id="nav-usuarios">‚öôÔ∏è Usuarios</button>' 
              : ''}
          </div>
        </div>

        <!-- Contenido principal -->
        <div class="container">
          <div id="mainContent">
            <div class="card">
              <p class="text-center text-gray-600">Cargando...</p>
            </div>
          </div>
        </div>
      </div>
    `;

    this.navigateTo('clientes');
  }

  navigateTo(tab) {
    this.currentTab = tab;
    
    // Actualizar tabs activos
    document.querySelectorAll('.nav-btn').forEach(btn => {
      btn.classList.remove('active');
    });
    const activeBtn = document.getElementById(`nav-${tab}`);
    if (activeBtn) activeBtn.classList.add('active');

    const content = document.getElementById('mainContent');
    
    switch(tab) {
      case 'clientes':
        content.innerHTML = this.renderClientesView();
        this.loadClientes();
        break;
      case 'productos':
  content.innerHTML = this.renderProductosView();
  this.loadProductos();
  break;
      case 'agenda':
  content.innerHTML = this.renderAgendaView();
  this.loadTareas('pendientes');
  break;
      case 'finanzas':
  content.innerHTML = this.renderFinanzasView();
  this.loadFinanzas('todas');
  break;
      case 'usuarios':
  if (this.currentUser.rol === 'ceo' || this.currentUser.rol === 'admin') {
    content.innerHTML = this.renderUsuariosView();
    this.loadUsuarios();
  }
  break;
      default:
        content.innerHTML = '<div class="card"><h2 class="text-xl font-bold">Secci√≥n en desarrollo</h2></div>';
    }
  }

  // ============================================
  // GESTI√ìN DE CLIENTES (contin√∫a en M√≥dulo 4)
  // ============================================
// ============================================
  // M√ìDULO 4: GESTI√ìN COMPLETA DE CLIENTES
  // ============================================
  
  renderClientesView() {
    return `
      <div>
        <div class="flex justify-between mb-4">
          <h2 class="text-2xl font-bold">Gesti√≥n de Clientes</h2>
          <button onclick="app.openModalCliente()" class="btn btn-gold">+ Nuevo Cliente</button>
        </div>
        <div id="clientesList" class="grid">
          <div class="card text-center py-8">
            <p class="text-gray-600">Cargando clientes...</p>
          </div>
        </div>
      </div>

      <!-- Modal Cliente -->
      <div id="modalCliente" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h2 class="text-xl font-bold" id="modalClienteTitle">Nuevo Cliente</h2>
            <button onclick="app.closeModalCliente()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6b7280;">√ó</button>
          </div>
          <form onsubmit="app.handleClienteSubmit(event)">
            <div class="modal-body">
              <div class="grid grid-2">
                <div class="mb-4">
                  <label class="label">Nombre Contacto *</label>
                  <input type="text" id="clienteNombre" class="input" required />
                </div>
                <div class="mb-4">
                  <label class="label">Empresa/Bar</label>
                  <input type="text" id="clienteEmpresa" class="input" />
                </div>
              </div>

              <div class="grid grid-2">
                <div class="mb-4">
                  <label class="label">Email</label>
                  <input type="email" id="clienteEmail" class="input" />
                </div>
                <div class="mb-4">
                  <label class="label">Tel√©fono</label>
                  <input type="tel" id="clienteTelefono" class="input" />
                </div>
              </div>

              <div class="mb-4">
                <label class="label">Direcci√≥n</label>
                <input type="text" id="clienteDireccion" class="input" />
              </div>

              <div class="grid grid-2">
                <div class="mb-4">
                  <label class="label">Fase *</label>
                  <select id="clienteFase" class="select" required>
                    <option value="contacto">Contacto Inicial</option>
                    <option value="muestras">Muestras Enviadas</option>
                    <option value="cliente">Cliente Activo</option>
                    <option value="perdido">No Interesado</option>
                  </select>
                </div>
                <div class="mb-4">
                  <label class="label">Asignar a</label>
                  <select id="clienteAsignado" class="select">
                    <option value="">Sin asignar</option>
                  </select>
                </div>
              </div>

              <div class="mb-4">
                <label class="label">Notas</label>
                <textarea id="clienteNotas" class="textarea"></textarea>
              </div>
            </div>

            <div class="modal-footer">
              <button type="button" onclick="app.closeModalCliente()" class="btn btn-gray">Cancelar</button>
              <button type="submit" class="btn btn-gold" id="btnGuardarCliente">Guardar Cliente</button>
            </div>
          </form>
        </div>
      </div>
    `;
  }

  async loadClientes() {
    try {
      let query = supabaseClient
        .from('clientes')
        .select('*, asignado:usuarios!clientes_asignado_a_fkey(id, nombre, email)')
        .order('fecha_creacion', { ascending: false });

      // Si es comercial, solo ver sus clientes y los sin asignar
      if (this.currentUser.rol === 'comercial') {
        query = query.or(`asignado_a.eq.${this.currentUser.id},asignado_a.is.null`);
      }

      const { data: clientes, error } = await query;
      if (error) throw error;

      const container = document.getElementById('clientesList');
      
      if (!clientes || clientes.length === 0) {
        container.innerHTML = `
          <div class="card text-center py-8">
            <p class="text-gray-600 mb-4">No hay clientes registrados</p>
            <button onclick="app.openModalCliente()" class="btn btn-gold">Crear Primer Cliente</button>
          </div>
        `;
        return;
      }

      container.innerHTML = clientes.map(c => `
        <div class="card">
          <div class="flex justify-between">
            <div style="flex: 1;">
              <div class="flex gap-2 mb-2" style="align-items: center;">
                <h3 class="text-lg font-bold">${c.nombre}</h3>
                <span class="badge ${this.getFaseColor(c.fase)}">${this.getFaseLabel(c.fase)}</span>
              </div>
              ${c.empresa ? `<p class="text-gray-600 font-bold">${c.empresa}</p>` : ''}
              <div class="mt-2" style="font-size: 0.875rem; color: #6b7280;">
                ${c.email ? `<p>üìß ${c.email}</p>` : ''}
                ${c.telefono ? `<p>üìû ${c.telefono}</p>` : ''}
                ${c.direccion ? `<p>üìç ${c.direccion}</p>` : ''}
              </div>
              <div class="mt-2">
                ${c.asignado ? 
                  `<span class="badge badge-green">üë§ ${c.asignado.nombre}</span>` : 
                  `<span class="badge badge-orange">‚ö†Ô∏è Sin asignar</span>
                   ${this.currentUser.rol === 'comercial' ? 
                     `<button onclick="app.tomarCliente('${c.id}', '${c.nombre}')" class="btn btn-blue btn-sm" style="margin-left: 0.5rem;">Tomar Cliente</button>` : ''}`
                }
              </div>
              ${c.notas ? `<p class="mt-2" style="font-size: 0.875rem; color: #6b7280; font-style: italic;">${c.notas}</p>` : ''}
            </div>
            <div class="flex gap-2" style="align-items: flex-start;">
              <button onclick="app.editCliente('${c.id}')" style="background: none; border: none; cursor: pointer; padding: 0.5rem; border-radius: 6px; font-size: 1.25rem;" title="Editar">‚úèÔ∏è</button>
              <button onclick="app.deleteCliente('${c.id}', '${c.nombre.replace(/'/g, "\\'")}')" style="background: none; border: none; cursor: pointer; padding: 0.5rem; border-radius: 6px; font-size: 1.25rem;" title="Eliminar">üóëÔ∏è</button>
            </div>
          </div>
        </div>
      `).join('');

    } catch (err) {
      console.error('Error cargando clientes:', err);
      document.getElementById('clientesList').innerHTML = `
        <div class="card text-center py-8">
          <p style="color: #ef4444;">Error cargando clientes</p>
          <button onclick="app.loadClientes()" class="btn btn-blue btn-sm mt-2">Reintentar</button>
        </div>
      `;
    }
  }

  getFaseColor(fase) {
    const colores = {
      contacto: 'badge-blue',
      muestras: 'badge-blue',
      cliente: 'badge-green',
      perdido: 'badge-orange'
    };
    return colores[fase] || 'badge-orange';
  }

  getFaseLabel(fase) {
    const labels = {
      contacto: 'Contacto',
      muestras: 'Muestras',
      cliente: 'Activo',
      perdido: 'Perdido'
    };
    return labels[fase] || fase;
  }

  // ============================================
  // MODAL CLIENTE
  // ============================================
  
  openModalCliente(cliente = null) {
    this.editingCliente = cliente;
    const modal = document.getElementById('modalCliente');
    const title = document.getElementById('modalClienteTitle');
    const btn = document.getElementById('btnGuardarCliente');

    // Llenar select de comerciales
    const selectAsignado = document.getElementById('clienteAsignado');
    selectAsignado.innerHTML = '<option value="">Sin asignar</option>' + 
      this.comerciales.map(c => `<option value="${c.id}">${c.nombre} (${c.rol})</option>`).join('');

    if (cliente) {
      // Modo edici√≥n
      title.textContent = 'Editar Cliente';
      btn.textContent = 'Actualizar Cliente';
      document.getElementById('clienteNombre').value = cliente.nombre || '';
      document.getElementById('clienteEmpresa').value = cliente.empresa || '';
      document.getElementById('clienteEmail').value = cliente.email || '';
      document.getElementById('clienteTelefono').value = cliente.telefono || '';
      document.getElementById('clienteDireccion').value = cliente.direccion || '';
      document.getElementById('clienteFase').value = cliente.fase || 'contacto';
      document.getElementById('clienteAsignado').value = cliente.asignado_a || '';
      document.getElementById('clienteNotas').value = cliente.notas || '';
    } else {
      // Modo creaci√≥n
      title.textContent = 'Nuevo Cliente';
      btn.textContent = 'Guardar Cliente';
      document.getElementById('clienteNombre').value = '';
      document.getElementById('clienteEmpresa').value = '';
      document.getElementById('clienteEmail').value = '';
      document.getElementById('clienteTelefono').value = '';
      document.getElementById('clienteDireccion').value = '';
      document.getElementById('clienteFase').value = 'contacto';
      document.getElementById('clienteNotas').value = '';
      
      // Si es comercial, auto-asignarse
      if (this.currentUser.rol === 'comercial') {
        document.getElementById('clienteAsignado').value = this.currentUser.id;
      } else {
        document.getElementById('clienteAsignado').value = '';
      }
    }

    modal.classList.add('active');
  }

  closeModalCliente() {
    document.getElementById('modalCliente').classList.remove('active');
    this.editingCliente = null;
  }

  async handleClienteSubmit(e) {
    e.preventDefault();

    const clienteData = {
      nombre: document.getElementById('clienteNombre').value,
      empresa: document.getElementById('clienteEmpresa').value || null,
      email: document.getElementById('clienteEmail').value || null,
      telefono: document.getElementById('clienteTelefono').value || null,
      direccion: document.getElementById('clienteDireccion').value || null,
      fase: document.getElementById('clienteFase').value,
      asignado_a: document.getElementById('clienteAsignado').value || null,
      notas: document.getElementById('clienteNotas').value || null,
      ultima_interaccion: new Date().toISOString()
    };

    try {
      if (this.editingCliente) {
        // Actualizar
        const { error } = await supabaseClient
          .from('clientes')
          .update(clienteData)
          .eq('id', this.editingCliente.id);

        if (error) throw error;

        await this.registrarActividad('actualizar', 'clientes', this.editingCliente.id, { 
          nombre: clienteData.nombre 
        });

        showNotification('‚úÖ Cliente actualizado correctamente');
      } else {
        // Crear nuevo
        clienteData.creado_por = this.currentUser.id;
        clienteData.fecha_creacion = new Date().toISOString();

        const { data, error } = await supabaseClient
          .from('clientes')
          .insert([clienteData])
          .select()
          .single();

        if (error) throw error;

        await this.registrarActividad('crear', 'clientes', data.id, { 
          nombre: clienteData.nombre 
        });

        // Crear tarea autom√°tica
        await this.crearTareaAutomatica(data);

        showNotification('‚úÖ Cliente creado correctamente');
      }

      this.closeModalCliente();
      this.loadClientes();

    } catch (err) {
      console.error('Error guardando cliente:', err);
      showNotification('‚ùå Error al guardar cliente');
    }
  }

  async editCliente(id) {
    try {
      const { data, error } = await supabaseClient
        .from('clientes')
        .select('*')
        .eq('id', id)
        .single();

      if (error) throw error;
      this.openModalCliente(data);
    } catch (err) {
      console.error('Error cargando cliente:', err);
      showNotification('‚ùå Error al cargar cliente');
    }
  }

  async deleteCliente(id, nombre) {
    if (!confirm(`¬øSeguro que quieres eliminar el cliente "${nombre}"?`)) return;

    try {
      const { error } = await supabaseClient
        .from('clientes')
        .delete()
        .eq('id', id);

      if (error) throw error;

      await this.registrarActividad('eliminar', 'clientes', id, { nombre });

      // Si es comercial, notificar a CEO
      if (this.currentUser.rol === 'comercial') {
        await this.notificarCEO(
          'cliente_eliminado',
          `${this.currentUser.nombre} elimin√≥ el cliente "${nombre}"`,
          { cliente_id: id, cliente_nombre: nombre }
        );
      }

      showNotification('‚úÖ Cliente eliminado');
      this.loadClientes();

    } catch (err) {
      console.error('Error eliminando cliente:', err);
      showNotification('‚ùå Error al eliminar cliente');
    }
  }

  async tomarCliente(id, nombre) {
    if (!confirm(`¬øQuieres asignarte el cliente "${nombre}"?`)) return;

    try {
      const { error } = await supabaseClient
        .from('clientes')
        .update({ 
          asignado_a: this.currentUser.id,
          ultima_interaccion: new Date().toISOString()
        })
        .eq('id', id);

      if (error) throw error;

      await this.registrarActividad('asignar', 'clientes', id, { 
        nombre, 
        asignado_a: this.currentUser.nombre 
      });

      // Notificar a CEO
      await this.notificarCEO(
        'cliente_tomado',
        `${this.currentUser.nombre} se asign√≥ el cliente "${nombre}"`,
        { cliente_id: id, cliente_nombre: nombre }
      );

      showNotification('‚úÖ Cliente asignado correctamente');
      this.loadClientes();

    } catch (err) {
      console.error('Error tomando cliente:', err);
      showNotification('‚ùå Error al asignar cliente');
    }
  }

  // ============================================
  // FUNCIONES AUXILIARES
  // ============================================

  async crearTareaAutomatica(cliente) {
    const diasPorFase = {
      contacto: 2,
      muestras: 7,
      cliente: 30
    };

    const descripcionesPorFase = {
      contacto: `Hacer seguimiento de contacto inicial con ${cliente.nombre}`,
      muestras: `Llamar para obtener feedback de muestras enviadas a ${cliente.nombre}`,
      cliente: `Contactar para renovar pedido de ${cliente.nombre}`
    };

    const dias = diasPorFase[cliente.fase];
    const descripcion = descripcionesPorFase[cliente.fase];

    if (!dias || !descripcion) return;

    const fechaTarea = new Date();
    fechaTarea.setDate(fechaTarea.getDate() + dias);

    try {
      await supabaseClient
        .from('tareas')
        .insert([{
          cliente_id: cliente.id,
          comercial_id: cliente.asignado_a || this.currentUser.id,
          descripcion: descripcion,
          fecha: fechaTarea.toISOString().split('T')[0],
          completada: false,
          tipo: 'seguimiento'
        }]);
    } catch (err) {
      console.error('Error creando tarea autom√°tica:', err);
    }
  }

  async registrarActividad(accion, tabla, registroId, datos) {
    try {
      await supabaseClient
        .from('historial_actividad')
        .insert([{
          usuario_id: this.currentUser.id,
          accion: accion,
          tabla: tabla,
          registro_id: registroId,
          datos_despues: datos
        }]);
    } catch (err) {
      console.error('Error registrando actividad:', err);
    }
  }

  async notificarCEO(tipo, mensaje, datos) {
    try {
      // Buscar CEO
      const { data: ceo } = await supabaseClient
        .from('usuarios')
        .select('id')
        .eq('rol', 'ceo')
        .eq('activo', true)
        .single();

      if (ceo) {
        await supabaseClient
          .from('notificaciones')
          .insert([{
            usuario_id: ceo.id,
            tipo: tipo,
            mensaje: mensaje,
            datos: datos,
            leida: false
          }]);
      }
    } catch (err) {
      console.error('Error notificando CEO:', err);
    }
  }

  // ============================================
  // FIN M√ìDULO 4
  // ============================================
// ============================================
  // M√ìDULO 5: GESTI√ìN DE PRODUCTOS Y PEDIDOS
  // ============================================

  renderProductosView() {
    return `
      <div>
        <div class="flex justify-between mb-4">
          <h2 class="text-2xl font-bold">Gesti√≥n de Productos</h2>
          <div class="flex gap-2">
            <button onclick="app.openModalPedido()" class="btn btn-blue">+ Nuevo Pedido</button>
            <button onclick="app.openModalProducto()" class="btn btn-gold">+ Nuevo Producto</button>
          </div>
        </div>

        <!-- Productos -->
        <div id="productosList" class="grid grid-2 mb-4">
          <div class="card text-center py-8">
            <p class="text-gray-600">Cargando productos...</p>
          </div>
        </div>

        <!-- Historial de Pedidos -->
        <div class="card">
          <h3 class="text-xl font-bold mb-4">Historial de Pedidos</h3>
          <div id="pedidosList">
            <p class="text-center text-gray-600">Cargando pedidos...</p>
          </div>
        </div>
      </div>

      <!-- Modal Producto -->
      <div id="modalProducto" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h2 class="text-xl font-bold" id="modalProductoTitle">Nuevo Producto</h2>
            <button onclick="app.closeModalProducto()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6b7280;">√ó</button>
          </div>
          <form onsubmit="app.handleProductoSubmit(event)">
            <div class="modal-body">
              <div class="mb-4">
                <label class="label">Nombre del Producto *</label>
                <input type="text" id="productoNombre" class="input" required />
              </div>

              <div class="grid grid-2">
                <div class="mb-4">
                  <label class="label">Stock *</label>
                  <input type="number" id="productoStock" class="input" required min="0" />
                </div>
                <div class="mb-4">
                  <label class="label">Precio (‚Ç¨) *</label>
                  <input type="number" id="productoPrecio" class="input" required min="0" step="0.01" />
                </div>
              </div>

              <div class="mb-4">
                <label class="label">Unidad</label>
                <select id="productoUnidad" class="select">
                  <option value="botellas">Botellas</option>
                  <option value="latas">Latas</option>
                  <option value="barriles">Barriles</option>
                  <option value="cajas">Cajas</option>
                </select>
              </div>
            </div>

            <div class="modal-footer">
              <button type="button" onclick="app.closeModalProducto()" class="btn btn-gray">Cancelar</button>
              <button type="submit" class="btn btn-gold" id="btnGuardarProducto">Guardar Producto</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Modal Pedido -->
      <div id="modalPedido" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h2 class="text-xl font-bold">Nuevo Pedido</h2>
            <button onclick="app.closeModalPedido()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6b7280;">√ó</button>
          </div>
          <form onsubmit="app.handlePedidoSubmit(event)">
            <div class="modal-body">
              <div class="mb-4">
                <label class="label">Cliente *</label>
                <select id="pedidoCliente" class="select" required>
                  <option value="">Seleccionar cliente...</option>
                </select>
              </div>

              <div class="mb-4">
                <label class="label">Producto *</label>
                <select id="pedidoProducto" class="select" required onchange="app.updatePedidoPrecio()">
                  <option value="">Seleccionar producto...</option>
                </select>
              </div>

              <div class="grid grid-2">
                <div class="mb-4">
                  <label class="label">Cantidad *</label>
                  <input type="number" id="pedidoCantidad" class="input" required min="1" oninput="app.calcularTotalPedido()" />
                </div>
                <div class="mb-4">
                  <label class="label">Precio Unitario (‚Ç¨)</label>
                  <input type="number" id="pedidoPrecio" class="input" required min="0" step="0.01" oninput="app.calcularTotalPedido()" />
                </div>
              </div>

              <div class="mb-4" style="background: #fef3c7; padding: 1rem; border-radius: 8px;">
                <p style="font-weight: 600;">Total: <span id="pedidoTotal">‚Ç¨0.00</span></p>
              </div>
            </div>

            <div class="modal-footer">
              <button type="button" onclick="app.closeModalPedido()" class="btn btn-gray">Cancelar</button>
              <button type="submit" class="btn btn-gold">Registrar Pedido</button>
            </div>
          </form>
        </div>
      </div>
    `;
  }

  async loadProductos() {
    try {
      const { data: productos, error } = await supabaseClient
        .from('productos')
        .select('*')
        .order('nombre', { ascending: true });

      if (error) throw error;

      const container = document.getElementById('productosList');
      
      if (!productos || productos.length === 0) {
        container.innerHTML = `
          <div class="card text-center py-8">
            <p class="text-gray-600 mb-4">No hay productos registrados</p>
            <button onclick="app.openModalProducto()" class="btn btn-gold">Crear Primer Producto</button>
          </div>
        `;
        return;
      }

      container.innerHTML = productos.map(p => {
        const stockBajo = p.stock < 50;
        return `
          <div class="card">
            <div class="flex justify-between mb-4">
              <div>
                <h3 class="text-lg font-bold">${p.nombre}</h3>
                <p class="text-2xl font-bold gold mt-2">‚Ç¨${parseFloat(p.precio).toFixed(2)}</p>
              </div>
              <div class="flex gap-2" style="align-items: flex-start;">
                <button onclick="app.editProducto('${p.id}')" style="background: none; border: none; cursor: pointer; padding: 0.5rem; font-size: 1.25rem;">‚úèÔ∏è</button>
                <button onclick="app.deleteProducto('${p.id}', '${p.nombre.replace(/'/g, "\\'")}')" style="background: none; border: none; cursor: pointer; padding: 0.5rem; font-size: 1.25rem;">üóëÔ∏è</button>
              </div>
            </div>
            <div style="padding: 0.75rem; border-radius: 8px; ${stockBajo ? 'background: #fef2f2; border: 1px solid #fca5a5;' : 'background: #d1fae5;'}">
              <p style="font-size: 0.875rem; font-weight: 600; ${stockBajo ? 'color: #dc2626;' : 'color: #065f46;'}">
                Stock: ${p.stock} ${p.unidad}
                ${stockBajo ? ' ‚ö†Ô∏è BAJO' : ''}
              </p>
            </div>
          </div>
        `;
      }).join('');

    } catch (err) {
      console.error('Error cargando productos:', err);
      document.getElementById('productosList').innerHTML = `
        <div class="card text-center py-8">
          <p style="color: #ef4444;">Error cargando productos</p>
        </div>
      `;
    }

    // Cargar tambi√©n los pedidos
    this.loadPedidos();
  }

  async loadPedidos() {
    try {
      let query = supabaseClient
        .from('pedidos')
        .select(`
          *,
          cliente:clientes(nombre, empresa),
          producto:productos(nombre),
          comercial:usuarios!pedidos_comercial_id_fkey(nombre)
        `)
        .order('fecha', { ascending: false })
        .limit(20);

      if (this.currentUser.rol === 'comercial') {
        query = query.eq('comercial_id', this.currentUser.id);
      }

      const { data: pedidos, error } = await query;
      if (error) throw error;

      const container = document.getElementById('pedidosList');
      
      if (!pedidos || pedidos.length === 0) {
        container.innerHTML = '<p class="text-center text-gray-600 py-4">No hay pedidos registrados</p>';
        return;
      }

      container.innerHTML = `
        <div style="overflow-x: auto;">
          <table style="width: 100%; border-collapse: collapse;">
            <thead style="background: #f9fafb;">
              <tr>
                <th style="padding: 0.75rem; text-align: left; font-size: 0.875rem; color: #374151;">Fecha</th>
                <th style="padding: 0.75rem; text-align: left; font-size: 0.875rem; color: #374151;">Cliente</th>
                <th style="padding: 0.75rem; text-align: left; font-size: 0.875rem; color: #374151;">Producto</th>
                <th style="padding: 0.75rem; text-align: left; font-size: 0.875rem; color: #374151;">Cantidad</th>
                ${this.currentUser.rol !== 'comercial' ? '<th style="padding: 0.75rem; text-align: left; font-size: 0.875rem; color: #374151;">Comercial</th>' : ''}
                <th style="padding: 0.75rem; text-align: left; font-size: 0.875rem; color: #374151;">Total</th>
              </tr>
            </thead>
            <tbody style="border-top: 1px solid #e5e7eb;">
              ${pedidos.map(p => `
                <tr style="border-bottom: 1px solid #e5e7eb;">
                  <td style="padding: 0.75rem; font-size: 0.875rem;">${new Date(p.fecha).toLocaleDateString()}</td>
                  <td style="padding: 0.75rem; font-size: 0.875rem; font-weight: 600;">${p.cliente?.nombre || 'N/A'}</td>
                  <td style="padding: 0.75rem; font-size: 0.875rem;">${p.producto?.nombre || 'N/A'}</td>
                  <td style="padding: 0.75rem; font-size: 0.875rem;">${p.cantidad}</td>
                  ${this.currentUser.rol !== 'comercial' ? `<td style="padding: 0.75rem; font-size: 0.875rem;">${p.comercial?.nombre || 'N/A'}</td>` : ''}
                  <td style="padding: 0.75rem; font-size: 0.875rem; font-weight: 700; color: #D4A574;">‚Ç¨${parseFloat(p.total).toFixed(2)}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;

    } catch (err) {
      console.error('Error cargando pedidos:', err);
    }
  }

  // ============================================
  // MODAL PRODUCTO
  // ============================================

  openModalProducto(producto = null) {
    this.editingProducto = producto;
    const modal = document.getElementById('modalProducto');
    const title = document.getElementById('modalProductoTitle');
    const btn = document.getElementById('btnGuardarProducto');

    if (producto) {
      title.textContent = 'Editar Producto';
      btn.textContent = 'Actualizar Producto';
      document.getElementById('productoNombre').value = producto.nombre || '';
      document.getElementById('productoStock').value = producto.stock || 0;
      document.getElementById('productoPrecio').value = producto.precio || 0;
      document.getElementById('productoUnidad').value = producto.unidad || 'botellas';
    } else {
      title.textContent = 'Nuevo Producto';
      btn.textContent = 'Guardar Producto';
      document.getElementById('productoNombre').value = '';
      document.getElementById('productoStock').value = 0;
      document.getElementById('productoPrecio').value = 0;
      document.getElementById('productoUnidad').value = 'botellas';
    }

    modal.classList.add('active');
  }

  closeModalProducto() {
    document.getElementById('modalProducto').classList.remove('active');
    this.editingProducto = null;
  }

  async handleProductoSubmit(e) {
    e.preventDefault();

    const productoData = {
      nombre: document.getElementById('productoNombre').value,
      stock: parseInt(document.getElementById('productoStock').value),
      precio: parseFloat(document.getElementById('productoPrecio').value),
      unidad: document.getElementById('productoUnidad').value
    };

    try {
      if (this.editingProducto) {
        const { error } = await supabaseClient
          .from('productos')
          .update(productoData)
          .eq('id', this.editingProducto.id);

        if (error) throw error;
        showNotification('‚úÖ Producto actualizado');
      } else {
        const { error } = await supabaseClient
          .from('productos')
          .insert([productoData]);

        if (error) throw error;
        showNotification('‚úÖ Producto creado');
      }

      this.closeModalProducto();
      this.loadProductos();

    } catch (err) {
      console.error('Error guardando producto:', err);
      showNotification('‚ùå Error al guardar producto');
    }
  }

  async editProducto(id) {
    try {
      const { data, error } = await supabaseClient
        .from('productos')
        .select('*')
        .eq('id', id)
        .single();

      if (error) throw error;
      this.openModalProducto(data);
    } catch (err) {
      console.error('Error cargando producto:', err);
      showNotification('‚ùå Error al cargar producto');
    }
  }

  async deleteProducto(id, nombre) {
    if (!confirm(`¬øSeguro que quieres eliminar "${nombre}"?`)) return;

    try {
      const { error } = await supabaseClient
        .from('productos')
        .delete()
        .eq('id', id);

      if (error) throw error;

      showNotification('‚úÖ Producto eliminado');
      this.loadProductos();

    } catch (err) {
      console.error('Error eliminando producto:', err);
      showNotification('‚ùå Error al eliminar producto');
    }
  }

  // ============================================
  // MODAL PEDIDO
  // ============================================

  async openModalPedido() {
    const modal = document.getElementById('modalPedido');

    // Cargar clientes activos
    try {
      let query = supabaseClient
        .from('clientes')
        .select('id, nombre, empresa')
        .eq('fase', 'cliente')
        .order('nombre', { ascending: true });

      if (this.currentUser.rol === 'comercial') {
        query = query.eq('asignado_a', this.currentUser.id);
      }

      const { data: clientes } = await query;

      const selectCliente = document.getElementById('pedidoCliente');
      selectCliente.innerHTML = '<option value="">Seleccionar cliente...</option>' +
        (clientes || []).map(c => `<option value="${c.id}">${c.nombre}${c.empresa ? ' - ' + c.empresa : ''}</option>`).join('');

      // Cargar productos
      const { data: productos } = await supabaseClient
        .from('productos')
        .select('*')
        .order('nombre', { ascending: true });

      const selectProducto = document.getElementById('pedidoProducto');
      selectProducto.innerHTML = '<option value="">Seleccionar producto...</option>' +
        (productos || []).map(p => `<option value="${p.id}" data-precio="${p.precio}" data-stock="${p.stock}">${p.nombre} (Stock: ${p.stock})</option>`).join('');

      document.getElementById('pedidoCantidad').value = 1;
      document.getElementById('pedidoPrecio').value = 0;
      document.getElementById('pedidoTotal').textContent = '‚Ç¨0.00';

      modal.classList.add('active');

    } catch (err) {
      console.error('Error abriendo modal pedido:', err);
      showNotification('‚ùå Error al cargar datos del pedido');
    }
  }

  closeModalPedido() {
    document.getElementById('modalPedido').classList.remove('active');
  }

  updatePedidoPrecio() {
    const select = document.getElementById('pedidoProducto');
    const selectedOption = select.options[select.selectedIndex];
    const precio = selectedOption.getAttribute('data-precio');
    document.getElementById('pedidoPrecio').value = precio || 0;
    this.calcularTotalPedido();
  }

  calcularTotalPedido() {
    const cantidad = parseFloat(document.getElementById('pedidoCantidad').value) || 0;
    const precio = parseFloat(document.getElementById('pedidoPrecio').value) || 0;
    const total = cantidad * precio;
    document.getElementById('pedidoTotal').textContent = `‚Ç¨${total.toFixed(2)}`;
  }

  async handlePedidoSubmit(e) {
    e.preventDefault();

    const clienteId = document.getElementById('pedidoCliente').value;
    const productoId = document.getElementById('pedidoProducto').value;
    const cantidad = parseInt(document.getElementById('pedidoCantidad').value);
    const precioUnitario = parseFloat(document.getElementById('pedidoPrecio').value);
    const total = cantidad * precioUnitario;

    // Verificar stock
    const selectProducto = document.getElementById('pedidoProducto');
    const selectedOption = selectProducto.options[selectProducto.selectedIndex];
    const stockDisponible = parseInt(selectedOption.getAttribute('data-stock'));

    if (cantidad > stockDisponible) {
      showNotification(`‚ùå Stock insuficiente. Disponible: ${stockDisponible}`);
      return;
    }

    try {
      // Registrar pedido
      const { error: errorPedido } = await supabaseClient
        .from('pedidos')
        .insert([{
          cliente_id: clienteId,
          producto_id: productoId,
          comercial_id: this.currentUser.id,
          cantidad: cantidad,
          precio_unitario: precioUnitario,
          total: total,
          fecha: new Date().toISOString()
        }]);

      if (errorPedido) throw errorPedido;

      // Actualizar stock
      const { error: errorStock } = await supabaseClient
        .from('productos')
        .update({ stock: stockDisponible - cantidad })
        .eq('id', productoId);

      if (errorStock) throw errorStock;

      // Registrar ingreso en finanzas
      await supabaseClient
        .from('finanzas')
        .insert([{
          tipo: 'ingreso',
          concepto: `Venta de ${cantidad} unidades`,
          monto: total,
          categoria: 'ventas',
          comercial_id: this.currentUser.id,
          fecha: new Date().toISOString()
        }]);

      showNotification('‚úÖ Pedido registrado correctamente');
      this.closeModalPedido();
      this.loadProductos();

    } catch (err) {
      console.error('Error registrando pedido:', err);
      showNotification('‚ùå Error al registrar pedido');
    }
  }

  // ============================================
  // FIN M√ìDULO 5
  // ============================================
// ============================================
  // M√ìDULO 6: AGENDA Y TAREAS
  // ============================================

  renderAgendaView() {
    return `
      <div>
        <div class="flex justify-between mb-4">
          <h2 class="text-2xl font-bold">Agenda y Tareas</h2>
          <button onclick="app.openModalTarea()" class="btn btn-gold">+ Nueva Tarea</button>
        </div>

        <!-- Resumen de tareas -->
        <div class="grid grid-2 mb-4">
          <div class="card" style="background: linear-gradient(135deg, #fef3c7, #fde68a); border-left: 4px solid #f59e0b;">
            <h3 class="font-bold mb-2">Tareas Pendientes</h3>
            <p class="text-3xl font-bold" style="color: #92400e;" id="countPendientes">0</p>
          </div>
          <div class="card" style="background: linear-gradient(135deg, #d1fae5, #a7f3d0); border-left: 4px solid #10b981;">
            <h3 class="font-bold mb-2">Tareas Completadas</h3>
            <p class="text-3xl font-bold" style="color: #065f46;" id="countCompletadas">0</p>
          </div>
        </div>

        <!-- Filtros -->
        <div class="card mb-4">
          <div class="flex gap-2" style="flex-wrap: wrap;">
            <button onclick="app.filtrarTareas('pendientes')" class="btn btn-sm" id="filtro-pendientes" style="background: #f59e0b; color: white;">Pendientes</button>
            <button onclick="app.filtrarTareas('hoy')" class="btn btn-sm btn-blue" id="filtro-hoy">Hoy</button>
            <button onclick="app.filtrarTareas('semana')" class="btn btn-sm btn-gray" id="filtro-semana">Esta Semana</button>
            <button onclick="app.filtrarTareas('completadas')" class="btn btn-sm btn-gray" id="filtro-completadas">Completadas</button>
            <button onclick="app.filtrarTareas('todas')" class="btn btn-sm btn-gray" id="filtro-todas">Todas</button>
          </div>
        </div>

        <!-- Lista de tareas -->
        <div id="tareasList">
          <div class="card text-center py-8">
            <p class="text-gray-600">Cargando tareas...</p>
          </div>
        </div>
      </div>

      <!-- Modal Tarea -->
      <div id="modalTarea" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h2 class="text-xl font-bold">Nueva Tarea</h2>
            <button onclick="app.closeModalTarea()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6b7280;">√ó</button>
          </div>
          <form onsubmit="app.handleTareaSubmit(event)">
            <div class="modal-body">
              <div class="mb-4">
                <label class="label">Cliente</label>
                <select id="tareaCliente" class="select">
                  <option value="">Sin cliente asociado</option>
                </select>
              </div>

              <div class="mb-4">
                <label class="label">Descripci√≥n *</label>
                <textarea id="tareaDescripcion" class="textarea" required placeholder="Ej: Llamar para seguimiento..."></textarea>
              </div>

              <div class="grid grid-2">
                <div class="mb-4">
                  <label class="label">Fecha *</label>
                  <input type="date" id="tareaFecha" class="input" required />
                </div>
                <div class="mb-4">
                  <label class="label">Tipo</label>
                  <select id="tareaTipo" class="select">
                    <option value="seguimiento">Seguimiento</option>
                    <option value="llamada">Llamada</option>
                    <option value="reunion">Reuni√≥n</option>
                    <option value="email">Email</option>
                    <option value="otro">Otro</option>
                  </select>
                </div>
              </div>
            </div>

            <div class="modal-footer">
              <button type="button" onclick="app.closeModalTarea()" class="btn btn-gray">Cancelar</button>
              <button type="submit" class="btn btn-gold">Guardar Tarea</button>
            </div>
          </form>
        </div>
      </div>
    `;
  }

  async loadTareas(filtro = 'pendientes') {
    try {
      let query = supabaseClient
        .from('tareas')
        .select('*, cliente:clientes(nombre, empresa), comercial:usuarios!tareas_comercial_id_fkey(nombre)')
        .order('fecha', { ascending: true });

      // Filtrar por comercial si no es CEO/Admin
      if (this.currentUser.rol === 'comercial') {
        query = query.eq('comercial_id', this.currentUser.id);
      }

      const { data: tareas, error } = await query;
      if (error) throw error;

      // Aplicar filtros
      let tareasFiltradas = tareas || [];
      const hoy = new Date().toISOString().split('T')[0];
      const semanaFin = new Date();
      semanaFin.setDate(semanaFin.getDate() + 7);
      const semanaFinStr = semanaFin.toISOString().split('T')[0];

      switch(filtro) {
        case 'pendientes':
          tareasFiltradas = tareasFiltradas.filter(t => !t.completada && t.fecha <= hoy);
          break;
        case 'hoy':
          tareasFiltradas = tareasFiltradas.filter(t => t.fecha === hoy);
          break;
        case 'semana':
          tareasFiltradas = tareasFiltradas.filter(t => !t.completada && t.fecha >= hoy && t.fecha <= semanaFinStr);
          break;
        case 'completadas':
          tareasFiltradas = tareasFiltradas.filter(t => t.completada);
          break;
        case 'todas':
          // Mostrar todas
          break;
      }

      // Actualizar contadores
      const pendientes = tareas.filter(t => !t.completada && t.fecha <= hoy).length;
      const completadas = tareas.filter(t => t.completada).length;
      document.getElementById('countPendientes').textContent = pendientes;
      document.getElementById('countCompletadas').textContent = completadas;

      // Actualizar botones activos
      document.querySelectorAll('[id^="filtro-"]').forEach(btn => {
        btn.classList.remove('btn-blue');
        btn.classList.add('btn-gray');
        btn.style.background = '';
        btn.style.color = '';
      });
      const btnActivo = document.getElementById(`filtro-${filtro}`);
      if (btnActivo) {
        btnActivo.classList.remove('btn-gray');
        btnActivo.classList.add('btn-blue');
      }

      const container = document.getElementById('tareasList');
      
      if (tareasFiltradas.length === 0) {
        container.innerHTML = `
          <div class="card text-center py-8">
            <p class="text-gray-600 mb-4">No hay tareas ${filtro === 'todas' ? 'registradas' : 'en esta categor√≠a'}</p>
            <button onclick="app.openModalTarea()" class="btn btn-gold">Crear Nueva Tarea</button>
          </div>
        `;
        return;
      }

      container.innerHTML = tareasFiltradas.map(t => {
        const fechaTarea = new Date(t.fecha + 'T00:00:00');
        const hoyDate = new Date(hoy + 'T00:00:00');
        const isPendiente = !t.completada && fechaTarea <= hoyDate;
        const isFutura = !t.completada && fechaTarea > hoyDate;
        const esHoy = t.fecha === hoy;

        return `
          <div class="card" style="border-left: 4px solid ${t.completada ? '#d1d5db' : isPendiente ? '#ef4444' : '#3b82f6'}; ${t.completada ? 'opacity: 0.7;' : ''}">
            <div class="flex" style="gap: 1rem;">
              <button 
                onclick="app.toggleTarea('${t.id}')" 
                style="width: 2rem; height: 2rem; min-width: 2rem; border-radius: 50%; border: 2px solid ${t.completada ? '#10b981' : '#d1d5db'}; background: ${t.completada ? '#10b981' : 'white'}; cursor: pointer; display: flex; align-items: center; justify-content: center; color: white; font-size: 1rem;"
              >
                ${t.completada ? '‚úì' : ''}
              </button>
              
              <div style="flex: 1;">
                <p class="font-bold ${t.completada ? 'text-gray-600' : ''}" style="${t.completada ? 'text-decoration: line-through;' : ''}">${t.descripcion}</p>
                
                ${t.cliente ? `<p class="text-sm text-gray-600 mt-1">üë§ Cliente: ${t.cliente.nombre}</p>` : ''}
                
                <div class="flex gap-2 mt-2" style="flex-wrap: wrap; align-items: center;">
                  <span class="badge ${esHoy ? 'badge-orange' : 'badge-blue'}" style="font-size: 0.75rem;">
                    üìÖ ${this.formatearFecha(t.fecha)}
                  </span>
                  
                  ${isPendiente && !t.completada ? '<span class="badge" style="background: #fef2f2; color: #dc2626;">‚ö†Ô∏è PENDIENTE</span>' : ''}
                  ${isFutura ? '<span class="badge badge-blue">üìÜ Programada</span>' : ''}
                  ${t.completada ? '<span class="badge badge-green">‚úì Completada</span>' : ''}
                  
                  <span class="badge" style="background: #f3f4f6; color: #6b7280;">${this.getTipoTareaLabel(t.tipo)}</span>
                  
                  ${this.currentUser.rol !== 'comercial' && t.comercial ? `<span class="badge badge-blue">üë§ ${t.comercial.nombre}</span>` : ''}
                </div>
              </div>
              
              <button 
                onclick="app.deleteTarea('${t.id}')" 
                style="background: none; border: none; cursor: pointer; padding: 0.5rem; font-size: 1.25rem; color: #6b7280; align-self: flex-start;"
                title="Eliminar"
              >
                üóëÔ∏è
              </button>
            </div>
          </div>
        `;
      }).join('');

    } catch (err) {
      console.error('Error cargando tareas:', err);
      document.getElementById('tareasList').innerHTML = `
        <div class="card text-center py-8">
          <p style="color: #ef4444;">Error cargando tareas</p>
          <button onclick="app.loadTareas('pendientes')" class="btn btn-blue btn-sm mt-2">Reintentar</button>
        </div>
      `;
    }
  }

  filtrarTareas(filtro) {
    this.loadTareas(filtro);
  }

  formatearFecha(fecha) {
    const f = new Date(fecha + 'T00:00:00');
    const hoy = new Date();
    hoy.setHours(0, 0, 0, 0);
    
    const diff = Math.floor((f - hoy) / (1000 * 60 * 60 * 24));
    
    if (diff === 0) return 'Hoy';
    if (diff === 1) return 'Ma√±ana';
    if (diff === -1) return 'Ayer';
    if (diff < -1) return `Hace ${Math.abs(diff)} d√≠as`;
    if (diff > 1) return `En ${diff} d√≠as`;
    
    return f.toLocaleDateString('es-ES', { day: 'numeric', month: 'short' });
  }

  getTipoTareaLabel(tipo) {
    const labels = {
      seguimiento: 'üìû Seguimiento',
      llamada: 'üìû Llamada',
      reunion: 'ü§ù Reuni√≥n',
      email: 'üìß Email',
      otro: 'üìã Otro'
    };
    return labels[tipo] || tipo;
  }

  // ============================================
  // MODAL TAREA
  // ============================================

  async openModalTarea() {
    const modal = document.getElementById('modalTarea');

    // Cargar clientes
    try {
      let query = supabaseClient
        .from('clientes')
        .select('id, nombre, empresa')
        .order('nombre', { ascending: true });

      if (this.currentUser.rol === 'comercial') {
        query = query.or(`asignado_a.eq.${this.currentUser.id},asignado_a.is.null`);
      }

      const { data: clientes } = await query;

      const selectCliente = document.getElementById('tareaCliente');
      selectCliente.innerHTML = '<option value="">Sin cliente asociado</option>' +
        (clientes || []).map(c => `<option value="${c.id}">${c.nombre}${c.empresa ? ' - ' + c.empresa : ''}</option>`).join('');

      // Fecha por defecto: hoy
      const hoy = new Date().toISOString().split('T')[0];
      document.getElementById('tareaFecha').value = hoy;
      document.getElementById('tareaDescripcion').value = '';
      document.getElementById('tareaTipo').value = 'seguimiento';

      modal.classList.add('active');

    } catch (err) {
      console.error('Error abriendo modal tarea:', err);
      showNotification('‚ùå Error al cargar datos');
    }
  }

  closeModalTarea() {
    document.getElementById('modalTarea').classList.remove('active');
  }

  async handleTareaSubmit(e) {
    e.preventDefault();

    const tareaData = {
      cliente_id: document.getElementById('tareaCliente').value || null,
      comercial_id: this.currentUser.id,
      descripcion: document.getElementById('tareaDescripcion').value,
      fecha: document.getElementById('tareaFecha').value,
      tipo: document.getElementById('tareaTipo').value,
      completada: false
    };

    try {
      const { error } = await supabaseClient
        .from('tareas')
        .insert([tareaData]);

      if (error) throw error;

      showNotification('‚úÖ Tarea creada correctamente');
      this.closeModalTarea();
      this.loadTareas('pendientes');

    } catch (err) {
      console.error('Error creando tarea:', err);
      showNotification('‚ùå Error al crear tarea');
    }
  }

  async toggleTarea(id) {
    try {
      // Obtener estado actual
      const { data: tarea } = await supabaseClient
        .from('tareas')
        .select('completada')
        .eq('id', id)
        .single();

      if (!tarea) return;

      // Cambiar estado
      const { error } = await supabaseClient
        .from('tareas')
        .update({ completada: !tarea.completada })
        .eq('id', id);

      if (error) throw error;

      showNotification(tarea.completada ? 'üìã Tarea marcada como pendiente' : '‚úÖ Tarea completada');
      
      // Recargar con el filtro actual
      const filtroActual = document.querySelector('[id^="filtro-"].btn-blue')?.id.replace('filtro-', '') || 'pendientes';
      this.loadTareas(filtroActual);

    } catch (err) {
      console.error('Error actualizando tarea:', err);
      showNotification('‚ùå Error al actualizar tarea');
    }
  }

  async deleteTarea(id) {
    if (!confirm('¬øEliminar esta tarea?')) return;

    try {
      const { error } = await supabaseClient
        .from('tareas')
        .delete()
        .eq('id', id);

      if (error) throw error;

      showNotification('‚úÖ Tarea eliminada');
      
      const filtroActual = document.querySelector('[id^="filtro-"].btn-blue')?.id.replace('filtro-', '') || 'pendientes';
      this.loadTareas(filtroActual);

    } catch (err) {
      console.error('Error eliminando tarea:', err);
      showNotification('‚ùå Error al eliminar tarea');
    }
  }

  // ============================================
  // FIN M√ìDULO 6
  // ============================================
// ============================================
  // M√ìDULO 7: FINANZAS Y COMISIONES
  // ============================================

  renderFinanzasView() {
    return `
      <div>
        <div class="flex justify-between mb-4">
          <h2 class="text-2xl font-bold">Control Financiero</h2>
          <button onclick="app.openModalFinanza()" class="btn btn-gold">+ Registrar Movimiento</button>
        </div>

        <!-- Resumen Financiero -->
        <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
          <div class="card" style="background: linear-gradient(135deg, #10b981, #059669); color: white;">
            <p style="opacity: 0.9; font-size: 0.875rem;">Total Ingresos</p>
            <p class="text-3xl font-bold mt-2" id="totalIngresos">‚Ç¨0.00</p>
          </div>
          <div class="card" style="background: linear-gradient(135deg, #ef4444, #dc2626); color: white;">
            <p style="opacity: 0.9; font-size: 0.875rem;">Total Gastos</p>
            <p class="text-3xl font-bold mt-2" id="totalGastos">‚Ç¨0.00</p>
          </div>
          <div class="card" style="background: linear-gradient(135deg, #D4A574, #C8A882); color: white;">
            <p style="opacity: 0.9; font-size: 0.875rem;">Balance Neto</p>
            <p class="text-3xl font-bold mt-2" id="balanceNeto">‚Ç¨0.00</p>
          </div>
        </div>

        <!-- Comisiones (solo para CEO/Admin) -->
        ${this.currentUser.rol !== 'comercial' ? `
          <div class="card mb-4">
            <h3 class="text-xl font-bold mb-4">Comisiones de Comerciales</h3>
            <div id="comisionesList">
              <p class="text-center text-gray-600">Cargando comisiones...</p>
            </div>
          </div>
        ` : ''}

        <!-- Filtros -->
        <div class="card mb-4">
          <div class="flex gap-2" style="flex-wrap: wrap;">
            <button onclick="app.filtrarFinanzas('todas')" class="btn btn-sm btn-blue" id="filtro-fin-todas">Todas</button>
            <button onclick="app.filtrarFinanzas('ingresos')" class="btn btn-sm btn-gray" id="filtro-fin-ingresos">Ingresos</button>
            <button onclick="app.filtrarFinanzas('gastos')" class="btn btn-sm btn-gray" id="filtro-fin-gastos">Gastos</button>
            <button onclick="app.filtrarFinanzas('mes')" class="btn btn-sm btn-gray" id="filtro-fin-mes">Este Mes</button>
          </div>
        </div>

        <!-- Lista de movimientos -->
        <div class="card">
          <h3 class="text-xl font-bold mb-4">Movimientos Recientes</h3>
          <div id="finanzasList">
            <p class="text-center text-gray-600">Cargando movimientos...</p>
          </div>
        </div>
      </div>

      <!-- Modal Finanza -->
      <div id="modalFinanza" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h2 class="text-xl font-bold">Registrar Movimiento</h2>
            <button onclick="app.closeModalFinanza()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6b7280;">√ó</button>
          </div>
          <form onsubmit="app.handleFinanzaSubmit(event)">
            <div class="modal-body">
              <div class="mb-4">
                <label class="label">Tipo *</label>
                <select id="finanzaTipo" class="select" required>
                  <option value="gasto">Gasto</option>
                  <option value="ingreso">Ingreso</option>
                </select>
              </div>

              <div class="mb-4">
                <label class="label">Concepto *</label>
                <input type="text" id="finanzaConcepto" class="input" required placeholder="Ej: Compra materias primas, Pago alquiler..." />
              </div>

              <div class="mb-4">
                <label class="label">Monto (‚Ç¨) *</label>
                <input type="number" id="finanzaMonto" class="input" required min="0" step="0.01" />
              </div>

              <div class="mb-4">
                <label class="label">Categor√≠a</label>
                <select id="finanzaCategoria" class="select">
                  <option value="">Seleccionar...</option>
                  <option value="ventas">Ventas</option>
                  <option value="materias_primas">Materias Primas</option>
                  <option value="marketing">Marketing</option>
                  <option value="transporte">Transporte</option>
                  <option value="alquiler">Alquiler</option>
                  <option value="servicios">Servicios</option>
                  <option value="nominas">N√≥minas</option>
                  <option value="otros">Otros</option>
                </select>
              </div>
            </div>

            <div class="modal-footer">
              <button type="button" onclick="app.closeModalFinanza()" class="btn btn-gray">Cancelar</button>
              <button type="submit" class="btn btn-gold">Registrar</button>
            </div>
          </form>
        </div>
      </div>
    `;
  }

  async loadFinanzas(filtro = 'todas') {
    try {
      let query = supabaseClient
        .from('finanzas')
        .select('*, comercial:usuarios!finanzas_comercial_id_fkey(nombre)')
        .order('fecha', { ascending: false });

      // Si es comercial, solo ver sus propios movimientos
      if (this.currentUser.rol === 'comercial') {
        query = query.eq('comercial_id', this.currentUser.id);
      }

      const { data: finanzas, error } = await query;
      if (error) throw error;

      // Aplicar filtros
      let finanzasFiltradas = finanzas || [];
      const hoy = new Date();
      const primerDiaMes = new Date(hoy.getFullYear(), hoy.getMonth(), 1).toISOString();

      switch(filtro) {
        case 'ingresos':
          finanzasFiltradas = finanzasFiltradas.filter(f => f.tipo === 'ingreso');
          break;
        case 'gastos':
          finanzasFiltradas = finanzasFiltradas.filter(f => f.tipo === 'gasto');
          break;
        case 'mes':
          finanzasFiltradas = finanzasFiltradas.filter(f => f.fecha >= primerDiaMes);
          break;
      }

      // Calcular totales
      const ingresos = finanzas.filter(f => f.tipo === 'ingreso').reduce((sum, f) => sum + parseFloat(f.monto || 0), 0);
      const gastos = finanzas.filter(f => f.tipo === 'gasto').reduce((sum, f) => sum + parseFloat(f.monto || 0), 0);
      const balance = ingresos - gastos;

      document.getElementById('totalIngresos').textContent = `‚Ç¨${ingresos.toFixed(2)}`;
      document.getElementById('totalGastos').textContent = `‚Ç¨${gastos.toFixed(2)}`;
      document.getElementById('balanceNeto').textContent = `‚Ç¨${balance.toFixed(2)}`;

      // Actualizar botones activos
      document.querySelectorAll('[id^="filtro-fin-"]').forEach(btn => {
        btn.classList.remove('btn-blue');
        btn.classList.add('btn-gray');
      });
      const btnActivo = document.getElementById(`filtro-fin-${filtro}`);
      if (btnActivo) {
        btnActivo.classList.remove('btn-gray');
        btnActivo.classList.add('btn-blue');
      }

      const container = document.getElementById('finanzasList');
      
      if (finanzasFiltradas.length === 0) {
        container.innerHTML = `
          <p class="text-center text-gray-600 py-4">No hay movimientos ${filtro === 'todas' ? 'registrados' : 'en esta categor√≠a'}</p>
        `;
        return;
      }

      container.innerHTML = `
        <div style="max-height: 500px; overflow-y: auto;">
          ${finanzasFiltradas.map(f => `
            <div class="mb-2" style="padding: 1rem; border-left: 4px solid ${f.tipo === 'ingreso' ? '#10b981' : '#ef4444'}; background: ${f.tipo === 'ingreso' ? '#f0fdf4' : '#fef2f2'}; border-radius: 8px;">
              <div class="flex justify-between" style="align-items: flex-start;">
                <div style="flex: 1;">
                  <p class="font-bold" style="color: ${f.tipo === 'ingreso' ? '#065f46' : '#991b1b'};">${f.concepto}</p>
                  <div class="flex gap-2 mt-1" style="flex-wrap: wrap; font-size: 0.875rem; color: #6b7280;">
                    <span>üìÖ ${new Date(f.fecha).toLocaleDateString()}</span>
                    ${f.categoria ? `<span class="badge" style="background: white;">üè∑Ô∏è ${this.getCategoriaLabel(f.categoria)}</span>` : ''}
                    ${this.currentUser.rol !== 'comercial' && f.comercial ? `<span class="badge" style="background: white;">üë§ ${f.comercial.nombre}</span>` : ''}
                  </div>
                </div>
                <div class="flex gap-2" style="align-items: center;">
                  <p class="text-xl font-bold" style="color: ${f.tipo === 'ingreso' ? '#065f46' : '#991b1b'};">
                    ${f.tipo === 'ingreso' ? '+' : '-'}‚Ç¨${parseFloat(f.monto).toFixed(2)}
                  </p>
                  ${(this.currentUser.rol === 'ceo' || this.currentUser.rol === 'admin') ? `
                    <button onclick="app.deleteFinanza('${f.id}')" style="background: none; border: none; cursor: pointer; padding: 0.5rem; font-size: 1rem; color: #6b7280;">üóëÔ∏è</button>
                  ` : ''}
                </div>
              </div>
            </div>
          `).join('')}
        </div>
      `;

      // Cargar comisiones si es CEO/Admin
      if (this.currentUser.rol !== 'comercial') {
        this.loadComisiones();
      }

    } catch (err) {
      console.error('Error cargando finanzas:', err);
      document.getElementById('finanzasList').innerHTML = `
        <p class="text-center" style="color: #ef4444;">Error cargando movimientos</p>
      `;
    }
  }

  async loadComisiones() {
    try {
      // Obtener comerciales con comisi√≥n configurada
      const { data: comerciales } = await supabaseClient
        .from('usuarios')
        .select('id, nombre, comision_porcentaje')
        .eq('rol', 'comercial')
        .eq('activo', true)
        .gt('comision_porcentaje', 0);

      if (!comerciales || comerciales.length === 0) {
        document.getElementById('comisionesList').innerHTML = `
          <p class="text-center text-gray-600">No hay comerciales con comisiones configuradas</p>
        `;
        return;
      }

      // Calcular ventas y comisiones de cada comercial
      const comisiones = await Promise.all(comerciales.map(async (c) => {
        const { data: pedidos } = await supabaseClient
          .from('pedidos')
          .select('total')
          .eq('comercial_id', c.id);

        const totalVentas = pedidos ? pedidos.reduce((sum, p) => sum + parseFloat(p.total || 0), 0) : 0;
        const comision = totalVentas * (c.comision_porcentaje / 100);

        return {
          nombre: c.nombre,
          porcentaje: c.comision_porcentaje,
          ventas: totalVentas,
          comision: comision
        };
      }));

      const container = document.getElementById('comisionesList');
      container.innerHTML = `
        <div style="overflow-x: auto;">
          <table style="width: 100%; border-collapse: collapse;">
            <thead style="background: #f9fafb;">
              <tr>
                <th style="padding: 0.75rem; text-align: left; font-size: 0.875rem; color: #374151;">Comercial</th>
                <th style="padding: 0.75rem; text-align: left; font-size: 0.875rem; color: #374151;">% Comisi√≥n</th>
                <th style="padding: 0.75rem; text-align: left; font-size: 0.875rem; color: #374151;">Ventas Totales</th>
                <th style="padding: 0.75rem; text-align: left; font-size: 0.875rem; color: #374151;">Comisi√≥n</th>
              </tr>
            </thead>
            <tbody style="border-top: 1px solid #e5e7eb;">
              ${comisiones.map(c => `
                <tr style="border-bottom: 1px solid #e5e7eb;">
                  <td style="padding: 0.75rem; font-size: 0.875rem; font-weight: 600;">${c.nombre}</td>
                  <td style="padding: 0.75rem; font-size: 0.875rem;">${c.porcentaje}%</td>
                  <td style="padding: 0.75rem; font-size: 0.875rem;">‚Ç¨${c.ventas.toFixed(2)}</td>
                  <td style="padding: 0.75rem; font-size: 0.875rem; font-weight: 700; color: #D4A574;">‚Ç¨${c.comision.toFixed(2)}</td>
                </tr>
              `).join('')}
              <tr style="background: #fef3c7; font-weight: 700;">
                <td colspan="3" style="padding: 0.75rem; font-size: 0.875rem; text-align: right;">TOTAL COMISIONES:</td>
                <td style="padding: 0.75rem; font-size: 0.875rem; color: #92400e;">‚Ç¨${comisiones.reduce((sum, c) => sum + c.comision, 0).toFixed(2)}</td>
              </tr>
            </tbody>
          </table>
        </div>
      `;

    } catch (err) {
      console.error('Error cargando comisiones:', err);
    }
  }

  filtrarFinanzas(filtro) {
    this.loadFinanzas(filtro);
  }

  getCategoriaLabel(categoria) {
    const labels = {
      ventas: 'Ventas',
      materias_primas: 'Materias Primas',
      marketing: 'Marketing',
      transporte: 'Transporte',
      alquiler: 'Alquiler',
      servicios: 'Servicios',
      nominas: 'N√≥minas',
      otros: 'Otros'
    };
    return labels[categoria] || categoria;
  }

  // ============================================
  // MODAL FINANZA
  // ============================================

  openModalFinanza() {
    const modal = document.getElementById('modalFinanza');
    document.getElementById('finanzaTipo').value = 'gasto';
    document.getElementById('finanzaConcepto').value = '';
    document.getElementById('finanzaMonto').value = '';
    document.getElementById('finanzaCategoria').value = '';
    modal.classList.add('active');
  }

  closeModalFinanza() {
    document.getElementById('modalFinanza').classList.remove('active');
  }

  async handleFinanzaSubmit(e) {
    e.preventDefault();

    const finanzaData = {
      tipo: document.getElementById('finanzaTipo').value,
      concepto: document.getElementById('finanzaConcepto').value,
      monto: parseFloat(document.getElementById('finanzaMonto').value),
      categoria: document.getElementById('finanzaCategoria').value || null,
      comercial_id: this.currentUser.id,
      fecha: new Date().toISOString()
    };

    try {
      const { error } = await supabaseClient
        .from('finanzas')
        .insert([finanzaData]);

      if (error) throw error;

      showNotification(`‚úÖ ${finanzaData.tipo === 'ingreso' ? 'Ingreso' : 'Gasto'} registrado correctamente`);
      this.closeModalFinanza();
      this.loadFinanzas('todas');

    } catch (err) {
      console.error('Error registrando movimiento:', err);
      showNotification('‚ùå Error al registrar movimiento');
    }
  }

  async deleteFinanza(id) {
    if (!confirm('¬øEliminar este movimiento?')) return;

    try {
      const { error } = await supabaseClient
        .from('finanzas')
        .delete()
        .eq('id', id);

      if (error) throw error;

      showNotification('‚úÖ Movimiento eliminado');
      
      const filtroActual = document.querySelector('[id^="filtro-fin-"].btn-blue')?.id.replace('filtro-fin-', '') || 'todas';
      this.loadFinanzas(filtroActual);

    } catch (err) {
      console.error('Error eliminando movimiento:', err);
      showNotification('‚ùå Error al eliminar movimiento');
    }
  }

  // ============================================
  // FIN M√ìDULO 7
  // ============================================
// ============================================
  // M√ìDULO 8: GESTI√ìN DE USUARIOS
  // ============================================

  renderUsuariosView() {
    return `
      <div>
        <div class="flex justify-between mb-4">
          <h2 class="text-2xl font-bold">Gesti√≥n de Usuarios</h2>
          <button onclick="app.openModalUsuario()" class="btn btn-gold">+ Nuevo Usuario</button>
        </div>

        <!-- Resumen de usuarios -->
        <div class="grid grid-2 mb-4">
          <div class="card" style="background: linear-gradient(135deg, #3b82f6, #2563eb); color: white;">
            <p style="opacity: 0.9; font-size: 0.875rem;">Total Usuarios</p>
            <p class="text-3xl font-bold mt-2" id="totalUsuarios">0</p>
          </div>
          <div class="card" style="background: linear-gradient(135deg, #10b981, #059669); color: white;">
            <p style="opacity: 0.9; font-size: 0.875rem;">Usuarios Activos</p>
            <p class="text-3xl font-bold mt-2" id="usuariosActivos">0</p>
          </div>
        </div>

        <!-- Lista de usuarios -->
        <div id="usuariosList" class="grid">
          <div class="card text-center py-8">
            <p class="text-gray-600">Cargando usuarios...</p>
          </div>
        </div>
      </div>

      <!-- Modal Usuario -->
      <div id="modalUsuario" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h2 class="text-xl font-bold" id="modalUsuarioTitle">Nuevo Usuario</h2>
            <button onclick="app.closeModalUsuario()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6b7280;">√ó</button>
          </div>
          <form onsubmit="app.handleUsuarioSubmit(event)">
            <div class="modal-body">
              <div class="mb-4">
                <label class="label">Nombre Completo *</label>
                <input type="text" id="usuarioNombre" class="input" required placeholder="Ej: Juan P√©rez" />
              </div>

              <div class="mb-4">
                <label class="label">Email *</label>
                <input type="email" id="usuarioEmail" class="input" required placeholder="usuario@versum.com" />
              </div>

              <div class="mb-4">
                <label class="label">Contrase√±a *</label>
                <input type="text" id="usuarioPassword" class="input" required placeholder="M√≠nimo 6 caracteres" minlength="6" />
                <p style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">El usuario podr√° cambiarla despu√©s del primer login</p>
              </div>

              <div class="grid grid-2">
                <div class="mb-4">
                  <label class="label">Rol *</label>
                  <select id="usuarioRol" class="select" required onchange="app.updateComisionField()">
                    <option value="comercial">Comercial</option>
                    <option value="admin">Administrador</option>
                    ${this.currentUser.rol === 'ceo' ? '<option value="ceo">CEO</option>' : ''}
                  </select>
                </div>
                <div class="mb-4" id="comisionField">
                  <label class="label">Comisi√≥n (%)</label>
                  <input type="number" id="usuarioComision" class="input" min="0" max="100" step="0.1" value="0" />
                </div>
              </div>

              <div class="mb-4">
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                  <input type="checkbox" id="usuarioActivo" checked style="width: 1.25rem; height: 1.25rem; cursor: pointer;" />
                  <span class="font-bold">Usuario Activo</span>
                </label>
              </div>
            </div>

            <div class="modal-footer">
              <button type="button" onclick="app.closeModalUsuario()" class="btn btn-gray">Cancelar</button>
              <button type="submit" class="btn btn-gold" id="btnGuardarUsuario">Guardar Usuario</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Modal Resetear Contrase√±a -->
      <div id="modalResetPassword" class="modal">
        <div class="modal-content" style="max-width: 400px;">
          <div class="modal-header">
            <h2 class="text-xl font-bold">Resetear Contrase√±a</h2>
            <button onclick="app.closeModalResetPassword()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6b7280;">√ó</button>
          </div>
          <form onsubmit="app.handleResetPasswordSubmit(event)">
            <div class="modal-body">
              <p class="mb-4 text-gray-600">Usuario: <strong id="resetPasswordNombre"></strong></p>
              <div class="mb-4">
                <label class="label">Nueva Contrase√±a *</label>
                <input type="text" id="resetPasswordNueva" class="input" required placeholder="M√≠nimo 6 caracteres" minlength="6" />
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" onclick="app.closeModalResetPassword()" class="btn btn-gray">Cancelar</button>
              <button type="submit" class="btn btn-gold">Resetear Contrase√±a</button>
            </div>
          </form>
        </div>
      </div>
    `;
  }

  async loadUsuarios() {
    try {
      const { data: usuarios, error } = await supabaseClient
        .from('usuarios')
        .select('*')
        .order('created_at', { ascending: false });

      if (error) throw error;

      // Actualizar contadores
      document.getElementById('totalUsuarios').textContent = usuarios.length;
      document.getElementById('usuariosActivos').textContent = usuarios.filter(u => u.activo).length;

      const container = document.getElementById('usuariosList');
      
      if (!usuarios || usuarios.length === 0) {
        container.innerHTML = `
          <div class="card text-center py-8">
            <p class="text-gray-600 mb-4">No hay usuarios registrados</p>
          </div>
        `;
        return;
      }

      container.innerHTML = usuarios.map(u => `
        <div class="card">
          <div class="flex justify-between" style="align-items: flex-start;">
            <div style="flex: 1;">
              <div class="flex gap-2 mb-2" style="align-items: center; flex-wrap: wrap;">
                <h3 class="text-lg font-bold">${u.nombre}</h3>
                <span class="badge ${this.getRolBadgeColor(u.rol)}">${this.getRolLabel(u.rol)}</span>
                ${!u.activo ? '<span class="badge" style="background: #fef2f2; color: #dc2626;">Inactivo</span>' : ''}
              </div>
              
              <p class="text-gray-600">üìß ${u.email}</p>
              
              ${u.comision_porcentaje > 0 ? `
                <p class="text-gray-600 mt-1">üí∞ Comisi√≥n: <strong>${u.comision_porcentaje}%</strong></p>
              ` : ''}
              
              <p style="font-size: 0.75rem; color: #9ca3af; margin-top: 0.5rem;">
                Creado: ${new Date(u.created_at).toLocaleDateString('es-ES', { day: 'numeric', month: 'short', year: 'numeric' })}
              </p>
            </div>
            
            <div class="flex gap-2" style="align-items: flex-start; flex-wrap: wrap;">
              ${u.id !== this.currentUser.id ? `
                <button 
                  onclick="app.toggleUsuarioActivo('${u.id}', ${u.activo})" 
                  class="btn btn-sm ${u.activo ? 'btn-red' : 'btn-blue'}"
                  style="font-size: 0.75rem;"
                >
                  ${u.activo ? 'Desactivar' : 'Activar'}
                </button>
                <button 
                  onclick="app.openModalResetPassword('${u.id}', '${u.nombre.replace(/'/g, "\\'")}')" 
                  class="btn btn-sm btn-gray"
                  style="font-size: 0.75rem;"
                >
                  Resetear Contrase√±a
                </button>
                <button 
                  onclick="app.editUsuario('${u.id}')" 
                  style="background: none; border: none; cursor: pointer; padding: 0.5rem; font-size: 1.25rem;"
                  title="Editar"
                >
                  ‚úèÔ∏è
                </button>
              ` : `
                <span class="badge badge-blue">T√∫</span>
              `}
            </div>
          </div>
        </div>
      `).join('');

    } catch (err) {
      console.error('Error cargando usuarios:', err);
      document.getElementById('usuariosList').innerHTML = `
        <div class="card text-center py-8">
          <p style="color: #ef4444;">Error cargando usuarios</p>
        </div>
      `;
    }
  }

  getRolBadgeColor(rol) {
    const colors = {
      ceo: 'badge' + ' ' + 'badge-orange',
      admin: 'badge-green',
      comercial: 'badge-blue'
    };
    return 'badge ' + (colors[rol] || 'badge-blue');
  }

  getRolLabel(rol) {
    const labels = {
      ceo: 'üëë CEO',
      admin: '‚öôÔ∏è Administrador',
      comercial: 'üíº Comercial'
    };
    return labels[rol] || rol;
  }

  // ============================================
  // MODAL USUARIO
  // ============================================

  openModalUsuario(usuario = null) {
    this.editingUsuario = usuario;
    const modal = document.getElementById('modalUsuario');
    const title = document.getElementById('modalUsuarioTitle');
    const btn = document.getElementById('btnGuardarUsuario');

    if (usuario) {
      // Modo edici√≥n
      title.textContent = 'Editar Usuario';
      btn.textContent = 'Actualizar Usuario';
      document.getElementById('usuarioNombre').value = usuario.nombre || '';
      document.getElementById('usuarioEmail').value = usuario.email || '';
      document.getElementById('usuarioPassword').value = '';
      document.getElementById('usuarioPassword').placeholder = 'Dejar en blanco para no cambiar';
      document.getElementById('usuarioPassword').required = false;
      document.getElementById('usuarioRol').value = usuario.rol || 'comercial';
      document.getElementById('usuarioComision').value = usuario.comision_porcentaje || 0;
      document.getElementById('usuarioActivo').checked = usuario.activo !== false;
    } else {
      // Modo creaci√≥n
      title.textContent = 'Nuevo Usuario';
      btn.textContent = 'Guardar Usuario';
      document.getElementById('usuarioNombre').value = '';
      document.getElementById('usuarioEmail').value = '';
      document.getElementById('usuarioPassword').value = '';
      document.getElementById('usuarioPassword').placeholder = 'M√≠nimo 6 caracteres';
      document.getElementById('usuarioPassword').required = true;
      document.getElementById('usuarioRol').value = 'comercial';
      document.getElementById('usuarioComision').value = 0;
      document.getElementById('usuarioActivo').checked = true;
    }

    this.updateComisionField();
    modal.classList.add('active');
  }

  closeModalUsuario() {
    document.getElementById('modalUsuario').classList.remove('active');
    this.editingUsuario = null;
  }

  updateComisionField() {
    const rol = document.getElementById('usuarioRol').value;
    const comisionField = document.getElementById('comisionField');
    
    if (rol === 'comercial') {
      comisionField.style.display = 'block';
    } else {
      comisionField.style.display = 'none';
      document.getElementById('usuarioComision').value = 0;
    }
  }

  async handleUsuarioSubmit(e) {
    e.preventDefault();

    const usuarioData = {
      nombre: document.getElementById('usuarioNombre').value,
      email: document.getElementById('usuarioEmail').value,
      rol: document.getElementById('usuarioRol').value,
      activo: document.getElementById('usuarioActivo').checked,
      comision_porcentaje: parseFloat(document.getElementById('usuarioComision').value) || 0
    };

    const password = document.getElementById('usuarioPassword').value;

    try {
      if (this.editingUsuario) {
        // Actualizar usuario existente
        const updateData = { ...usuarioData };
        
        // Si hay nueva contrase√±a, actualizarla
        if (password) {
          updateData.password_hash = password;
        }

        const { error } = await supabaseClient
          .from('usuarios')
          .update(updateData)
          .eq('id', this.editingUsuario.id);

        if (error) throw error;

        showNotification('‚úÖ Usuario actualizado correctamente');
        
        // Si edit√≥ su propio usuario, actualizar sesi√≥n
        if (this.editingUsuario.id === this.currentUser.id) {
          this.currentUser = { ...this.currentUser, ...usuarioData };
          localStorage.setItem('versum_user', JSON.stringify(this.currentUser));
        }

      } else {
        // Crear nuevo usuario
        usuarioData.password_hash = password;
        usuarioData.created_at = new Date().toISOString();

        const { error } = await supabaseClient
          .from('usuarios')
          .insert([usuarioData]);

        if (error) {
          if (error.code === '23505') {
            showNotification('‚ùå Este email ya est√° registrado');
            return;
          }
          throw error;
        }

        showNotification('‚úÖ Usuario creado correctamente');
      }

      this.closeModalUsuario();
      this.loadUsuarios();
      await this.loadComerciales(); // Actualizar lista de comerciales

    } catch (err) {
      console.error('Error guardando usuario:', err);
      showNotification('‚ùå Error al guardar usuario');
    }
  }

  async editUsuario(id) {
    try {
      const { data, error } = await supabaseClient
        .from('usuarios')
        .select('*')
        .eq('id', id)
        .single();

      if (error) throw error;
      this.openModalUsuario(data);
    } catch (err) {
      console.error('Error cargando usuario:', err);
      showNotification('‚ùå Error al cargar usuario');
    }
  }

  async toggleUsuarioActivo(id, activo) {
    const accion = activo ? 'desactivar' : 'activar';
    if (!confirm(`¬øSeguro que quieres ${accion} este usuario?`)) return;

    try {
      const { error } = await supabaseClient
        .from('usuarios')
        .update({ activo: !activo })
        .eq('id', id);

      if (error) throw error;

      showNotification(`‚úÖ Usuario ${activo ? 'desactivado' : 'activado'}`);
      this.loadUsuarios();
      await this.loadComerciales(); // Actualizar lista de comerciales

    } catch (err) {
      console.error('Error actualizando usuario:', err);
      showNotification('‚ùå Error al actualizar usuario');
    }
  }

  // ============================================
  // RESETEAR CONTRASE√ëA
  // ============================================

  openModalResetPassword(id, nombre) {
    this.resetPasswordUserId = id;
    const modal = document.getElementById('modalResetPassword');
    document.getElementById('resetPasswordNombre').textContent = nombre;
    document.getElementById('resetPasswordNueva').value = '';
    modal.classList.add('active');
  }

  closeModalResetPassword() {
    document.getElementById('modalResetPassword').classList.remove('active');
    this.resetPasswordUserId = null;
  }

  async handleResetPasswordSubmit(e) {
    e.preventDefault();

    const nuevaPassword = document.getElementById('resetPasswordNueva').value;

    try {
      const { error } = await supabaseClient
        .from('usuarios')
        .update({ password_hash: nuevaPassword })
        .eq('id', this.resetPasswordUserId);

      if (error) throw error;

      showNotification('‚úÖ Contrase√±a reseteada correctamente');
      this.closeModalResetPassword();

    } catch (err) {
      console.error('Error reseteando contrase√±a:', err);
      showNotification('‚ùå Error al resetear contrase√±a');
    }
  }

  // ============================================
  // FIN M√ìDULO 8
  // ============================================
  // ============================================
// MODIFICACI√ìN 5: EDITAR PEDIDOS
// ============================================
// Pega esto DENTRO de la clase VersumCRM, en el M√≥dulo 5
// Reemplaza las funciones relacionadas con pedidos

// MODIFICAR: Actualizar loadPedidos para a√±adir bot√≥n de editar
async loadPedidos() {
  try {
    let query = supabaseClient
      .from('pedidos')
      .select(`
        *,
        cliente:clientes(nombre, empresa),
        producto:productos(nombre),
        comercial:usuarios!pedidos_comercial_id_fkey(nombre)
      `)
      .order('fecha', { ascending: false })
      .limit(20);

    if (this.currentUser.rol === 'comercial') {
      query = query.eq('comercial_id', this.currentUser.id);
    }

    const { data: pedidos, error } = await query;
    if (error) throw error;

    const container = document.getElementById('pedidosList');
    
    if (!pedidos || pedidos.length === 0) {
      container.innerHTML = '<p class="text-center text-gray-600 py-4">No hay pedidos registrados</p>';
      return;
    }

    const puedeEditarTodos = this.currentUser.rol === 'ceo' || this.currentUser.rol === 'admin';

    container.innerHTML = `
      <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse;">
          <thead style="background: #f9fafb;">
            <tr>
              <th style="padding: 0.75rem; text-align: left; font-size: 0.875rem; color: #374151;">Fecha</th>
              <th style="padding: 0.75rem; text-align: left; font-size: 0.875rem; color: #374151;">Cliente</th>
              <th style="padding: 0.75rem; text-align: left; font-size: 0.875rem; color: #374151;">Producto</th>
              <th style="padding: 0.75rem; text-align: left; font-size: 0.875rem; color: #374151;">Cantidad</th>
              <th style="padding: 0.75rem; text-align: left; font-size: 0.875rem; color: #374151;">Precio Unit.</th>
              ${this.currentUser.rol !== 'comercial' ? '<th style="padding: 0.75rem; text-align: left; font-size: 0.875rem; color: #374151;">Comercial</th>' : ''}
              <th style="padding: 0.75rem; text-align: left; font-size: 0.875rem; color: #374151;">Total</th>
              <th style="padding: 0.75rem; text-align: left; font-size: 0.875rem; color: #374151;">Acciones</th>
            </tr>
          </thead>
          <tbody style="border-top: 1px solid #e5e7eb;">
            ${pedidos.map(p => {
              const puedeEditar = puedeEditarTodos || p.comercial_id === this.currentUser.id;
              return `
                <tr style="border-bottom: 1px solid #e5e7eb;">
                  <td style="padding: 0.75rem; font-size: 0.875rem;">${new Date(p.fecha).toLocaleDateString()}</td>
                  <td style="padding: 0.75rem; font-size: 0.875rem; font-weight: 600;">${p.cliente?.nombre || 'N/A'}</td>
                  <td style="padding: 0.75rem; font-size: 0.875rem;">${p.producto?.nombre || 'N/A'}</td>
                  <td style="padding: 0.75rem; font-size: 0.875rem;">${p.cantidad}</td>
                  <td style="padding: 0.75rem; font-size: 0.875rem;">‚Ç¨${parseFloat(p.precio_unitario).toFixed(2)}</td>
                  ${this.currentUser.rol !== 'comercial' ? `<td style="padding: 0.75rem; font-size: 0.875rem;">${p.comercial?.nombre || 'N/A'}</td>` : ''}
                  <td style="padding: 0.75rem; font-size: 0.875rem; font-weight: 700; color: #D4A574;">‚Ç¨${parseFloat(p.total).toFixed(2)}</td>
                  <td style="padding: 0.75rem; font-size: 0.875rem;">
                    ${puedeEditar ? `
                      <button 
                        onclick="app.editPedido('${p.id}')" 
                        style="background: none; border: none; cursor: pointer; padding: 0.25rem; font-size: 1rem;"
                        title="Editar"
                      >
                        ‚úèÔ∏è
                      </button>
                      <button 
                        onclick="app.deletePedido('${p.id}')" 
                        style="background: none; border: none; cursor: pointer; padding: 0.25rem; font-size: 1rem; color: #ef4444;"
                        title="Eliminar"
                      >
                        üóëÔ∏è
                      </button>
                    ` : '<span style="color: #9ca3af;">‚Äî</span>'}
                  </td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      </div>
    `;

  } catch (err) {
    console.error('Error cargando pedidos:', err);
  }
}

// NUEVA FUNCI√ìN: Editar pedido
async editPedido(id) {
  try {
    // Cargar datos del pedido
    const { data: pedido, error } = await supabaseClient
      .from('pedidos')
      .select(`
        *,
        cliente:clientes(id, nombre, empresa),
        producto:productos(id, nombre, stock, precio)
      `)
      .eq('id', id)
      .single();

    if (error) throw error;

    this.editingPedido = pedido;
    
    // Abrir modal con datos precargados
    await this.openModalEditarPedido(pedido);

  } catch (err) {
    console.error('Error cargando pedido:', err);
    showNotification('‚ùå Error al cargar pedido');
  }
}

// NUEVA FUNCI√ìN: Modal editar pedido
async openModalEditarPedido(pedido) {
  const modal = document.createElement('div');
  modal.id = 'modalEditarPedido';
  modal.className = 'modal active';
  
  // Cargar clientes y productos
  let clientesQuery = supabaseClient
    .from('clientes')
    .select('id, nombre, empresa')
    .eq('fase', 'cliente')
    .order('nombre', { ascending: true });

  if (this.currentUser.rol === 'comercial') {
    clientesQuery = clientesQuery.eq('asignado_a', this.currentUser.id);
  }

  const { data: clientes } = await clientesQuery;
  const { data: productos } = await supabaseClient
    .from('productos')
    .select('*')
    .order('nombre', { ascending: true });

  modal.innerHTML = `
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="text-xl font-bold">Editar Pedido</h2>
        <button onclick="document.getElementById('modalEditarPedido').remove()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6b7280;">√ó</button>
      </div>
      <form onsubmit="app.handleEditarPedidoSubmit(event)">
        <div class="modal-body">
          <div class="mb-4">
            <label class="label">Cliente *</label>
            <select id="editPedidoCliente" class="select" required>
              ${(clientes || []).map(c => `
                <option value="${c.id}" ${c.id === pedido.cliente_id ? 'selected' : ''}>
                  ${c.nombre}${c.empresa ? ' - ' + c.empresa : ''}
                </option>
              `).join('')}
            </select>
          </div>

          <div class="mb-4">
            <label class="label">Producto *</label>
            <select id="editPedidoProducto" class="select" required onchange="app.updateEditPedidoPrecio()">
              ${(productos || []).map(p => `
                <option value="${p.id}" data-precio="${p.precio}" data-stock="${p.stock}" ${p.id === pedido.producto_id ? 'selected' : ''}>
                  ${p.nombre} (Stock: ${p.stock}${pedido.producto_id === p.id ? ' + ' + pedido.cantidad : ''})
                </option>
              `).join('')}
            </select>
            <p style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">
              Stock actual incluye la cantidad de este pedido
            </p>
          </div>

          <div class="grid grid-2">
            <div class="mb-4">
              <label class="label">Cantidad *</label>
              <input 
                type="number" 
                id="editPedidoCantidad" 
                class="input" 
                required 
                min="1" 
                value="${pedido.cantidad}"
                oninput="app.calcularEditTotalPedido()" 
              />
            </div>
            <div class="mb-4">
              <label class="label">Precio Unitario (‚Ç¨)</label>
              <input 
                type="number" 
                id="editPedidoPrecio" 
                class="input" 
                required 
                min="0" 
                step="0.01" 
                value="${pedido.precio_unitario}"
                oninput="app.calcularEditTotalPedido()" 
              />
            </div>
          </div>

          <div class="mb-4" style="background: #fef3c7; padding: 1rem; border-radius: 8px;">
            <p style="font-weight: 600;">Total: <span id="editPedidoTotal">‚Ç¨${parseFloat(pedido.total).toFixed(2)}</span></p>
          </div>

          <input type="hidden" id="editPedidoId" value="${pedido.id}" />
          <input type="hidden" id="editPedidoCantidadOriginal" value="${pedido.cantidad}" />
          <input type="hidden" id="editPedidoProductoIdOriginal" value="${pedido.producto_id}" />
        </div>

        <div class="modal-footer">
          <button type="button" onclick="document.getElementById('modalEditarPedido').remove()" class="btn btn-gray">Cancelar</button>
          <button type="submit" class="btn btn-gold">Actualizar Pedido</button>
        </div>
      </form>
    </div>
  `;
  
  document.body.appendChild(modal);
}

// NUEVA FUNCI√ìN: Actualizar precio al cambiar producto en edici√≥n
updateEditPedidoPrecio() {
  const select = document.getElementById('editPedidoProducto');
  const selectedOption = select.options[select.selectedIndex];
  const precio = selectedOption.getAttribute('data-precio');
  document.getElementById('editPedidoPrecio').value = precio || 0;
  this.calcularEditTotalPedido();
}

// NUEVA FUNCI√ìN: Calcular total en edici√≥n
calcularEditTotalPedido() {
  const cantidad = parseFloat(document.getElementById('editPedidoCantidad').value) || 0;
  const precio = parseFloat(document.getElementById('editPedidoPrecio').value) || 0;
  const total = cantidad * precio;
  document.getElementById('editPedidoTotal').textContent = `‚Ç¨${total.toFixed(2)}`;
}

// NUEVA FUNCI√ìN: Manejar actualizaci√≥n de pedido
async handleEditarPedidoSubmit(e) {
  e.preventDefault();

  const pedidoId = document.getElementById('editPedidoId').value;
  const clienteId = document.getElementById('editPedidoCliente').value;
  const productoIdNuevo = document.getElementById('editPedidoProducto').value;
  const cantidadNueva = parseInt(document.getElementById('editPedidoCantidad').value);
  const precioUnitario = parseFloat(document.getElementById('editPedidoPrecio').value);
  const total = cantidadNueva * precioUnitario;

  const cantidadOriginal = parseInt(document.getElementById('editPedidoCantidadOriginal').value);
  const productoIdOriginal = document.getElementById('editPedidoProductoIdOriginal').value;

  try {
    // 1. Restaurar stock del producto original
    if (productoIdOriginal) {
      const { data: productoOriginal } = await supabaseClient
        .from('productos')
        .select('stock')
        .eq('id', productoIdOriginal)
        .single();

      if (productoOriginal) {
        await supabaseClient
          .from('productos')
          .update({ stock: productoOriginal.stock + cantidadOriginal })
          .eq('id', productoIdOriginal);
      }
    }

    // 2. Verificar stock del producto nuevo
    const { data: productoNuevo } = await supabaseClient
      .from('productos')
      .select('stock')
      .eq('id', productoIdNuevo)
      .single();

    if (!productoNuevo || productoNuevo.stock < cantidadNueva) {
      showNotification(`‚ùå Stock insuficiente. Disponible: ${productoNuevo?.stock || 0}`);
      
      // Revertir stock del producto original
      if (productoIdOriginal) {
        const { data: productoOriginal } = await supabaseClient
          .from('productos')
          .select('stock')
          .eq('id', productoIdOriginal)
          .single();
        
        await supabaseClient
          .from('productos')
          .update({ stock: productoOriginal.stock - cantidadOriginal })
          .eq('id', productoIdOriginal);
      }
      return;
    }

    // 3. Descontar stock del producto nuevo
    await supabaseClient
      .from('productos')
      .update({ stock: productoNuevo.stock - cantidadNueva })
      .eq('id', productoIdNuevo);

    // 4. Actualizar pedido
    const { error: errorPedido } = await supabaseClient
      .from('pedidos')
      .update({
        cliente_id: clienteId,
        producto_id: productoIdNuevo,
        cantidad: cantidadNueva,
        precio_unitario: precioUnitario,
        total: total
      })
      .eq('id', pedidoId);

    if (errorPedido) throw errorPedido;

    // 5. Actualizar finanzas si cambi√≥ el total
    const diferencia = total - (cantidadOriginal * precioUnitario);
    if (diferencia !== 0) {
      await supabaseClient
        .from('finanzas')
        .insert([{
          tipo: diferencia > 0 ? 'ingreso' : 'gasto',
          concepto: `Ajuste de pedido (${diferencia > 0 ? '+' : ''}${diferencia.toFixed(2)})`,
          monto: Math.abs(diferencia),
          categoria: 'ventas',
          comercial_id: this.currentUser.id,
          fecha: new Date().toISOString()
        }]);
    }

    showNotification('‚úÖ Pedido actualizado correctamente');
    document.getElementById('modalEditarPedido').remove();
    this.loadProductos();

  } catch (err) {
    console.error('Error actualizando pedido:', err);
    showNotification('‚ùå Error al actualizar pedido');
  }
}

// NUEVA FUNCI√ìN: Eliminar pedido
async deletePedido(id) {
  if (!confirm('¬øEliminar este pedido? El stock se restaurar√° autom√°ticamente.')) return;

  try {
    // Obtener datos del pedido
    const { data: pedido } = await supabaseClient
      .from('pedidos')
      .select('producto_id, cantidad, total')
      .eq('id', id)
      .single();

    if (!pedido) {
      showNotification('‚ùå Pedido no encontrado');
      return;
    }

    // Restaurar stock
    const { data: producto } = await supabaseClient
      .from('productos')
      .select('stock')
      .eq('id', pedido.producto_id)
      .single();

    if (producto) {
      await supabaseClient
        .from('productos')
        .update({ stock: producto.stock + pedido.cantidad })
        .eq('id', pedido.producto_id);
    }

    // Eliminar pedido
    const { error } = await supabaseClient
      .from('pedidos')
      .delete()
      .eq('id', id);

    if (error) throw error;

    // Registrar ajuste en finanzas
    await supabaseClient
      .from('finanzas')
      .insert([{
        tipo: 'gasto',
        concepto: `Pedido eliminado (devoluci√≥n)`,
        monto: pedido.total,
        categoria: 'ventas',
        comercial_id: this.currentUser.id,
        fecha: new Date().toISOString()
      }]);

    showNotification('‚úÖ Pedido eliminado y stock restaurado');
    this.loadProductos();

  } catch (err) {
    console.error('Error eliminando pedido:', err);
    showNotification('‚ùå Error al eliminar pedido');
  }
}

// ============================================
// FIN MODIFICACI√ìN 5
// ============================================
}// Inicializar aplicaci√≥n
const app = new VersumCRM();
  </script>
</body>
</html>



